# ì¸ì¦ ì‹œìŠ¤í…œ ì™„ì „ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨

1. [ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”](#1-ì „ì²´-ì•„í‚¤í…ì²˜-ê°œìš”)
2. [JWT í† í° ê¸°ì´ˆ](#2-jwt-í† í°-ê¸°ì´ˆ)
3. [Spring Security í•„í„° ì²´ì¸](#3-spring-security-í•„í„°-ì²´ì¸)
4. [ë¡œê·¸ì¸ íë¦„ (ìƒì„¸)](#4-ë¡œê·¸ì¸-íë¦„-ìƒì„¸)
5. [ì¸ì¦ëœ ìš”ì²­ ì²˜ë¦¬ íë¦„](#5-ì¸ì¦ëœ-ìš”ì²­-ì²˜ë¦¬-íë¦„)
6. [í† í° ì¬ë°œê¸‰ íë¦„](#6-í† í°-ì¬ë°œê¸‰-íë¦„)
7. [ë¡œê·¸ì•„ì›ƒ íë¦„](#7-ë¡œê·¸ì•„ì›ƒ-íë¦„)
8. [ê¶Œí•œ ì²´í¬ (AOP)](#8-ê¶Œí•œ-ì²´í¬-aop)
9. [ì¿ í‚¤ ê´€ë¦¬](#9-ì¿ í‚¤-ê´€ë¦¬)
10. [Redis ì‚¬ìš©](#10-redis-ì‚¬ìš©)
11. [ë³´ì•ˆ ê³ ë ¤ì‚¬í•­](#11-ë³´ì•ˆ-ê³ ë ¤ì‚¬í•­)
12. [ì„œë²„ë³„ ì—­í•  ìƒì„¸](#12-ì„œë²„ë³„-ì—­í• -ìƒì„¸)

---

## 1. ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”

### 1.1 ì„œë²„ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP ìš”ì²­ (ì¿ í‚¤ í¬í•¨)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Front ì„œë²„ (Port: 5173)              â”‚
â”‚  - Thymeleaf (SSR)                              â”‚
â”‚  - JwtAuthenticationFilter (ì»¤ìŠ¤í…€ í•„í„°)        â”‚
â”‚  - Spring Security Filter Chain                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ FeignClient
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gateway ì„œë²„ (Port: 8080)               â”‚
â”‚  - JwtValidationFilter (JWT ê²€ì¦)                â”‚
â”‚  - X-Member-Id, X-User-Role í—¤ë” ì¶”ê°€           â”‚
â”‚  - ë¼ìš°íŒ… (Eureka ê¸°ë°˜)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â†“                 â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Auth ì„œë²„    â”‚ â”‚ Core ì„œë²„    â”‚ â”‚ ê¸°íƒ€ ì„œë²„    â”‚
â”‚ (Port: 9000) â”‚ â”‚ (Port: 9100) â”‚ â”‚              â”‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â”‚ - JWT ë°œê¸‰   â”‚ â”‚ - ë¹„ì¦ˆë‹ˆìŠ¤   â”‚ â”‚              â”‚
â”‚ - í† í° ê²€ì¦  â”‚ â”‚   ë¡œì§       â”‚ â”‚              â”‚
â”‚ - Redis      â”‚ â”‚ - ê¶Œí•œ ì²´í¬  â”‚ â”‚              â”‚
â”‚   (Refresh)  â”‚ â”‚   (AOP)      â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ì£¼ìš” ê¸°ìˆ  ìŠ¤íƒ

| ê¸°ìˆ  | ìš©ë„ | ìœ„ì¹˜ |
|------|------|------|
| **JWT** | AccessToken (1ì‹œê°„), RefreshToken (3ì¼) | Auth ì„œë²„ |
| **Redis** | RefreshToken ì €ì¥ì†Œ | Auth ì„œë²„ |
| **Spring Security** | ì¸ì¦/ì¸ê°€ í•„í„° ì²´ì¸ | Front ì„œë²„ |
| **FeignClient** | ì„œë²„ ê°„ í†µì‹  | Front â†’ Auth |
| **AOP** | ê¶Œí•œ ì²´í¬ | Core ì„œë²„ |
| **Gateway** | API Gateway, ë¼ìš°íŒ… | Gateway ì„œë²„ |

### 1.3 ì¸ì¦ ë°©ì‹

- **Stateless ì¸ì¦**: ì„¸ì…˜ ì‚¬ìš© ì•ˆ í•¨
- **JWT ê¸°ë°˜**: í† í°ìœ¼ë¡œ ì¸ì¦
- **ì¿ í‚¤ ì €ì¥**: HttpOnly, Secure, SameSite=Lax
- **ì´ì¤‘ ì €ì¥**: RefreshTokenì€ ì¿ í‚¤ + Redis

---

## 2. JWT í† í° ê¸°ì´ˆ

### 2.1 JWT êµ¬ì¡°

```
Header.Payload.Signature
```

#### Header (í—¤ë”)
```json
{
  "alg": "HS256",  // ì•Œê³ ë¦¬ì¦˜: HMAC-SHA256
  "typ": "JWT"     // íƒ€ì…: JWT
}
```

#### Payload (í˜ì´ë¡œë“œ) - AccessToken
```json
{
  "sub": "123",           // Subject: memberId
  "userType": "member",   // ì‚¬ìš©ì íƒ€ì…: "member" or "admin"
  "iat": 1234567890,      // Issued At: ë°œê¸‰ ì‹œê°„
  "exp": 1234571490       // Expiration: ë§Œë£Œ ì‹œê°„ (1ì‹œê°„ í›„)
}
```

#### Payload (í˜ì´ë¡œë“œ) - RefreshToken
```json
{
  "sub": "123",           // Subject: memberId
  "type": "refresh",      // í† í° íƒ€ì…: RefreshToken í‘œì‹œ
  "userType": "member",   // ì‚¬ìš©ì íƒ€ì…
  "iat": 1234567890,      // Issued At
  "exp": 1234605090       // Expiration: ë§Œë£Œ ì‹œê°„ (3ì¼ í›„)
}
```

#### Signature (ì„œëª…)
```
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secretKey
)
```

### 2.2 í† í° ìƒì„± ì½”ë“œ

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/util/JwtTokenProvider.java`

```java
@Component
@RequiredArgsConstructor
public class JwtTokenProvider {
    
    private static final String CLAIM_TYPE = "type";
    private static final String TYPE_REFRESH = "refresh";
    private static final String CLAIM_USER_TYPE = "userType";
    
    private final JwtProperties jwtProperties;
    
    // HMAC-SHA256 Secret Key ìƒì„±
    private SecretKey getSecretKey() {
        return Keys.hmacShaKeyFor(
            jwtProperties.getSecret().getBytes(StandardCharsets.UTF_8)
        );
    }
    
    // AccessToken ìƒì„±
    public String createAccessToken(Long id, String userType) {
        Date now = new Date();
        Date expiration = new Date(
            now.getTime() + jwtProperties.getAccess().getExp() * 1000
        ); // 1ì‹œê°„ (3600ì´ˆ)
        
        return Jwts.builder()
                .subject(String.valueOf(id))      // memberId
                .claim(CLAIM_USER_TYPE, userType) // "member" or "admin"
                .issuedAt(now)
                .expiration(expiration)
                .signWith(getSecretKey())         // HMAC-SHA256 ì„œëª…
                .compact();
    }
    
    // RefreshToken ìƒì„±
    public String createRefreshToken(Long id, String userType) {
        Date now = new Date();
        Date expiration = new Date(
            now.getTime() + jwtProperties.getRefresh().getExp() * 1000
        ); // 3ì¼ (259200ì´ˆ)
        
        return Jwts.builder()
                .subject(String.valueOf(id))
                .claim(CLAIM_TYPE, TYPE_REFRESH)  // RefreshToken í‘œì‹œ
                .claim(CLAIM_USER_TYPE, userType)
                .issuedAt(now)
                .expiration(expiration)
                .signWith(getSecretKey())
                .compact();
    }
    
    // í† í° ìŒ ìƒì„±
    public TokenPair createTokenPair(Long id, String userType) {
        String accessToken = createAccessToken(id, userType);
        String refreshToken = createRefreshToken(id, userType);
        return new TokenPair(accessToken, refreshToken);
    }
}
```

### 2.3 í† í° ê²€ì¦ ì½”ë“œ

```java
// í† í° ìœ íš¨ì„± ê²€ì¦
public boolean validateToken(String token) {
    if (token == null || token.trim().isEmpty()) {
        return false;
    }
    
    try {
        Jwts.parser()
                .verifyWith(getSecretKey())
                .build()
                .parseSignedClaims(token);
        return true;
    } catch (Exception e) {
        return false;
    }
}

// í† í° íŒŒì‹± (Claims ì¶”ì¶œ)
public Claims parseToken(String token) {
    try {
        return Jwts.parser()
                .verifyWith(getSecretKey())
                .build()
                .parseSignedClaims(token)
                .getPayload();
    } catch (ExpiredJwtException e) {
        throw new AuthException(AuthErrorCode.TOKEN_EXPIRED, e);
    } catch (MalformedJwtException | SignatureException e) {
        throw new AuthException(AuthErrorCode.TOKEN_INVALID, e);
    } catch (Exception e) {
        throw new AuthException(AuthErrorCode.TOKEN_PARSE_FAILED, e);
    }
}

// memberId ì¶”ì¶œ
public Long getMemberIdFromToken(String token) {
    Claims claims = parseToken(token);
    return Long.parseLong(claims.getSubject());
}

// userType ì¶”ì¶œ
public String getUserTypeFromToken(String token) {
    Claims claims = parseToken(token);
    return claims.get(CLAIM_USER_TYPE, String.class);
}

// RefreshTokenì¸ì§€ í™•ì¸
public boolean isRefreshToken(String token) {
    try {
        Claims claims = parseToken(token);
        String type = claims.get(CLAIM_TYPE, String.class);
        return TYPE_REFRESH.equals(type);
    } catch (AuthException e) {
        return false;
    }
}
```

### 2.4 í† í° ì„¤ì •

**íŒŒì¼**: `chaekmate-auth/src/main/resources/application.yml`

```yaml
jwt:
  secret: ${JWT_SECRET_KEY}  # HMAC-SHA256 Secret Key
  access:
    exp: ${ACCESS_TOKEN_EXPIRED_AT:3600}      # 1ì‹œê°„ (ê¸°ë³¸ê°’)
  refresh:
    exp: ${REFRESH_TOKEN_EXPIRED_AT:259200}   # 3ì¼ (ê¸°ë³¸ê°’)
```

---

## 3. Spring Security í•„í„° ì²´ì¸

### 3.1 ì „ì²´ í•„í„° ì²´ì¸ ìˆœì„œ

```
HTTP ìš”ì²­
  â†“
1. DisableEncodeUrlFilter
   - URL ì¸ì½”ë”© ë¹„í™œì„±í™”
  â†“
2. WebAsyncManagerIntegrationFilter
   - ë¹„ë™ê¸° ìš”ì²­ ì²˜ë¦¬ ì§€ì›
  â†“
3. SecurityContextHolderFilter â­
   - SecurityContextë¥¼ ThreadLocalì— ì €ì¥/ì •ë¦¬
   - ìš”ì²­ ì‹œì‘: SecurityContext ìƒì„±
   - ìš”ì²­ ì¢…ë£Œ: SecurityContext ì •ë¦¬
   - â­ ì´ìœ : JwtAuthenticationFilterì—ì„œ SecurityContextì— ì¸ì¦ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ”ë° í•„ìˆ˜
  â†“
4. HeaderWriterFilter
   - ë³´ì•ˆ í—¤ë” ì¶”ê°€ (X-Frame-Options, X-Content-Type-Options ë“±)
  â†“
5. CsrfFilter
   - CSRF ë³´í˜¸ (í”„ë¡œì íŠ¸ì—ì„œëŠ” ë¹„í™œì„±í™”)
  â†“
6. LogoutFilter â­
   - /logout ìš”ì²­ ì²˜ë¦¬
   - CustomLogoutHandler ì‹¤í–‰ (í”„ë¡œì íŠ¸ì—ì„œ ì»¤ìŠ¤í…€ êµ¬í˜„)
   - SecurityContext ì •ë¦¬
   - â­ ì´ìœ : SecurityConfigì—ì„œ .logout() ì„¤ì • ë° CustomLogoutHandler ì‚¬ìš©
  â†“
7. RequestCacheAwareFilter
   - ì¸ì¦ ì „ ìš”ì²­ ìºì‹œ ê´€ë¦¬
  â†“
8. SecurityContextHolderAwareRequestFilter
   - HttpServletRequestë¥¼ SecurityContextHolderAwareRequestWrapperë¡œ ë˜í•‘
  â†“
9. AnonymousAuthenticationFilter
   - ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì—ê²Œ ìµëª… ì¸ì¦ ë¶€ì—¬
   - ROLE_ANONYMOUS ê¶Œí•œ ì„¤ì •
  â†“
10. SessionManagementFilter
    - ì„¸ì…˜ ê´€ë¦¬ (í”„ë¡œì íŠ¸ì—ì„œëŠ” STATELESS)
    - ì„¸ì…˜ ìƒì„± ì•ˆ í•¨
  â†“
11. ExceptionTranslationFilter â­
    - ì¸ì¦/ì¸ê°€ ì˜ˆì™¸ ì²˜ë¦¬
    - AuthenticationException â†’ authenticationEntryPoint
    - AccessDeniedException â†’ accessDeniedHandler
    - â­ ì´ìœ : SecurityConfigì—ì„œ .exceptionHandling() ì„¤ì • (authenticationEntryPoint)
  â†“
12. JwtAuthenticationFilter â­ (ì»¤ìŠ¤í…€ í•„í„°)
    - JWT í† í° ê²€ì¦
    - SecurityContextì— ì¸ì¦ ì •ë³´ ì €ì¥
    - ìœ„ì¹˜: UsernamePasswordAuthenticationFilter ì•
    - â­ ì´ìœ : í”„ë¡œì íŠ¸ì—ì„œ ì§ì ‘ êµ¬í˜„í•œ ì»¤ìŠ¤í…€ í•„í„° (SecurityConfigì—ì„œ ì¶”ê°€)
  â†“
13. UsernamePasswordAuthenticationFilter
    - í¼ ë¡œê·¸ì¸ ì²˜ë¦¬ (í”„ë¡œì íŠ¸ì—ì„œëŠ” ì‚¬ìš© ì•ˆ í•¨)
  â†“
14. AuthorizationFilter â­
    - ê¶Œí•œ ì²´í¬
    - SecurityContextì˜ Authentication í™•ì¸
    - ê¶Œí•œ ì—†ìœ¼ë©´ AccessDeniedException ë°œìƒ
    - â­ ì´ìœ : SecurityConfigì—ì„œ .authorizeHttpRequests() ì„¤ì • (permitAll, hasRole, authenticated)
  â†“
Controller
```
â­ëŠ” í”„ë¡œì íŠ¸ì—ì„œ ì§ì ‘ ì„¤ì •í•˜ê±°ë‚˜ ì»¤ìŠ¤í…€ êµ¬í˜„ì´ ìˆëŠ” í•„í„°, ë˜ëŠ” ì¸ì¦/ì¸ê°€ì˜ í•µì‹¬ ì—­í• ì„ í•˜ëŠ” í•„í„°ë¥¼ í‘œì‹œ

### 3.2 í•„í„° ì¶”ê°€ ìœ„ì¹˜

**íŒŒì¼**: `chaekmate-front/src/main/java/shop/chaekmate/front/auth/config/SecurityConfig.java`

```java
.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
```

- **ìœ„ì¹˜**: UsernamePasswordAuthenticationFilter (13ë²ˆ) ì•
- **ì´ìœ **: í¼ ë¡œê·¸ì¸ ì „ì— JWT ì¸ì¦ì„ ë¨¼ì € ì²˜ë¦¬

### 3.3 SecurityConfig ì „ì²´ ì„¤ì •

```java
@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtAuthenticationFilter;
    private final CustomLogoutHandler customLogoutHandler;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            // CSRF ë³´í˜¸ ë¹„í™œì„±í™”
            .csrf(AbstractHttpConfigurer::disable)
            
            // Stateless ì„¸ì…˜ ì •ì±…
            .sessionManagement(session ->
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            
            // ê¶Œí•œ ì„¤ì •
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/admin/login").permitAll()
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .requestMatchers("/", "/login", "/signup").permitAll()
                .requestMatchers("/dormant/verify").permitAll()
                .requestMatchers("/books/**").permitAll()
                .requestMatchers("/members/**").authenticated()
                .requestMatchers("/mypage/**", "/logout").authenticated()
                .anyRequest().authenticated()
            )
            
            // ì˜ˆì™¸ ì²˜ë¦¬
            .exceptionHandling(ex -> ex
                .authenticationEntryPoint(
                    (request, response, authException) -> 
                        response.sendRedirect("/login")
                )
            )
            
            // ë¡œê·¸ì•„ì›ƒ ì„¤ì •
            .logout(logout -> logout
                .logoutUrl("/logout")
                .addLogoutHandler(customLogoutHandler)
                .logoutSuccessUrl("/")
            )
            
            // ì»¤ìŠ¤í…€ í•„í„° ì¶”ê°€
            .addFilterBefore(
                jwtAuthenticationFilter, 
                UsernamePasswordAuthenticationFilter.class
            );

        return http.build();
    }
}
```

---

## 4. ë¡œê·¸ì¸ íë¦„ (ìƒì„¸)

### 4.1 ì „ì²´ íë¦„ë„

```
ì‚¬ìš©ì ì…ë ¥ (loginId, password)
  â†“
Front ì„œë²„: POST /login
  â†“
Front ì„œë²„: AuthService.login() â†’ FeignClient
  â†“
Gateway ì„œë²„: JwtValidationFilter (í† í° ì—†ìŒ â†’ í†µê³¼)
  â†“
Auth ì„œë²„: POST /auth/login
  â†“
Auth ì„œë²„: AuthService.memberLogin()
  - ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
  - íœ´ë©´ ê³„ì • ì²´í¬
  - JWT í† í° ë°œê¸‰
  â†“
Auth ì„œë²„: ì¿ í‚¤ ì„¤ì • + Redis ì €ì¥
  â†“
Front ì„œë²„: Set-Cookie í—¤ë”ë¥¼ ë¸Œë¼ìš°ì €ì— ì „ë‹¬
  â†“
ë¸Œë¼ìš°ì €: ì¿ í‚¤ ì €ì¥ (accessToken, refreshToken)
```

### 4.2 ë‹¨ê³„ë³„ ìƒì„¸ ì½”ë“œ

#### Step 1: Front ì„œë²„ - ë¡œê·¸ì¸ ìš”ì²­ ë°›ê¸°

**íŒŒì¼**: `chaekmate-front/src/main/java/shop/chaekmate/front/auth/controller/AuthController.java`

```java
@PostMapping("/login")
public String login(@RequestParam String loginId,
                     @RequestParam String password,
                     HttpServletResponse response) {
    try {
        // 1. LoginRequest DTO ìƒì„±
        LoginRequest request = new LoginRequest(loginId, password);
        
        // 2. Auth ì„œë²„ì— ë¡œê·¸ì¸ ìš”ì²­ (FeignClient)
        ResponseEntity<LoginResponse> gatewayResponse = authService.login(request);
        
        // 3. Set-Cookie í—¤ë” ì¶”ì¶œí•˜ì—¬ ë¸Œë¼ìš°ì €ì— ì „ë‹¬
        if (gatewayResponse.getHeaders().containsKey(HttpHeaders.SET_COOKIE)) {
            List<String> cookieHeaders = gatewayResponse.getHeaders().get(HttpHeaders.SET_COOKIE);
            if (cookieHeaders != null) {
                cookieHeaders.forEach(cookieHeader -> 
                    response.addHeader(HttpHeaders.SET_COOKIE, cookieHeader)
                );
            }
        }
        
        // 4. ì„±ê³µ ì‹œ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (gatewayResponse.getStatusCode().is2xxSuccessful()) {
            return REDIRECT_HOME;
        } else {
            return REDIRECT_LOGIN_ERROR;
        }
    } catch (FeignException.Unauthorized e) {
        // íœ´ë©´ íšŒì› ì˜ˆì™¸ ì²˜ë¦¬
        if (e.contentUTF8().contains(AuthErrorCode.DORMANT_MEMBER.getMessage())) {
            return REDIRECT_DORMANT_VERIFY + "?loginId=" + loginId;
        }
        return REDIRECT_LOGIN_ERROR;
    } catch (Exception e) {
        return REDIRECT_LOGIN_ERROR;
    }
}
```

#### Step 2: Front ì„œë²„ - FeignClientë¡œ Auth ì„œë²„ í˜¸ì¶œ

**íŒŒì¼**: `chaekmate-front/src/main/java/shop/chaekmate/front/auth/service/AuthService.java`

```java
@Service
@RequiredArgsConstructor
public class AuthService {
    
    private final AuthAdaptor authAdaptor;
    
    public ResponseEntity<LoginResponse> login(LoginRequest request) {
        // FeignClientë¥¼ í†µí•´ Gateway â†’ Auth ì„œë²„ë¡œ ìš”ì²­
        return authAdaptor.login(request);
    }
}
```

**íŒŒì¼**: `chaekmate-front/src/main/java/shop/chaekmate/front/auth/adaptor/AuthAdaptor.java`

```java
@FeignClient(
    name = "auth-client", 
    url = "${chaekmate.gateway.url}",
    configuration = AuthFeignClientConfig.class
)
public interface AuthAdaptor {
    
    @PostMapping("/auth/login")
    ResponseEntity<LoginResponse> login(@RequestBody LoginRequest request);
}
```

**íŠ¹ì§•**: `AuthFeignClientConfig`ë¥¼ í†µí•´ `FeignCookieInterceptor`ê°€ ìë™ìœ¼ë¡œ ì¿ í‚¤ë¥¼ ì „ë‹¬

#### Step 3: Gateway ì„œë²„ - JWT ê²€ì¦ í•„í„°

**íŒŒì¼**: `chaekmate-gateway/src/main/java/shop/chaekmate/gateway/filter/JwtValidationFilter.java`

```java
@Override
public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
    ServerHttpRequest request = exchange.getRequest();
    String accessToken = extractAccessTokenFromCookie(request);
    
    // ë¡œê·¸ì¸ ìš”ì²­ì€ í† í°ì´ ì—†ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ í†µê³¼
    if (!StringUtils.hasText(accessToken)) {
        return chain.filter(exchange);
    }
    
    // í† í°ì´ ìˆìœ¼ë©´ ê²€ì¦ (ì¸ì¦ëœ ìš”ì²­ ì²˜ë¦¬)
    // ...
}
```

#### Step 4: Auth ì„œë²„ - ë¡œê·¸ì¸ ì²˜ë¦¬

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/controller/AuthController.java`

```java
@PostMapping("/login")
public ResponseEntity<LoginResponse> memberLogin(
        @Valid @RequestBody LoginRequest request,
        HttpServletResponse response) {
    
    // 1. ë¡œê·¸ì¸ ì²˜ë¦¬ ë° í† í° ë°œê¸‰
    TokenPair tokenPair = authService.memberLogin(request);
    
    // 2. ì¿ í‚¤ ì„¤ì •
    responseCookieUtil.addTokenCookies(response, tokenPair);
    log.info("ì¼ë°˜ ë¡œê·¸ì¸ - í† í° ì¿ í‚¤ ì„¤ì • ì™„ë£Œ");
    
    // 3. Redisì— RefreshToken ì €ì¥
    Long memberId = jwtTokenProvider.getMemberIdFromToken(tokenPair.accessToken());
    String redisKey = "refresh:" + memberId;
    long refreshExpirationMillis = jwtTokenProvider.getRefreshTokenExpiration() * 1000;
    redisTemplate.opsForValue().set(
        redisKey, 
        tokenPair.refreshToken(),
        Duration.ofMillis(refreshExpirationMillis)
    );
    
    return ResponseEntity.ok(new LoginResponse("ë¡œê·¸ì¸ ì„±ê³µ"));
}
```

#### Step 5: Auth ì„œë²„ - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/service/AuthService.java`

```java
public TokenPair memberLogin(LoginRequest request) {
    // 1. íšŒì› ì¡°íšŒ
    Optional<Member> memberOpt = memberRepository.findByLoginId(request.loginId());
    
    if (memberOpt.isPresent()) {
        Member member = memberOpt.get();
        
        // 2. ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
        if (passwordEncoder.matches(request.password(), member.getPassword())) {
            
            // 3. íœ´ë©´ ê³„ì • ì²´í¬ (3ê°œì›” ì´ìƒ ë¯¸ì ‘ì†)
            if (isDormantMember(member.getLastLoginAt())) {
                // Dooray ë©”ì‹œì§€ë¡œ ì¸ì¦ë²ˆí˜¸ ì „ì†¡
                doorayService.sendDormantVerificationCode(member.getId());
                // íœ´ë©´ íšŒì› ì˜ˆì™¸ ë°œìƒ
                throw new AuthException(AuthErrorCode.DORMANT_MEMBER);
            }
            
            // 4. ì¼ë°˜ íšŒì›: ë¡œê·¸ì¸ ì²˜ë¦¬
            member.updateLastLoginAt();
            memberRepository.save(member);
            
            // 5. JWT í† í° ë°œê¸‰
            return jwtTokenProvider.createTokenPair(
                member.getId(), 
                JwtTokenProvider.getTypeMember()
            );
        }
    }
    
    throw new AuthException(AuthErrorCode.INVALID_CREDENTIALS);
}

private boolean isDormantMember(LocalDateTime lastLoginAt) {
    if (lastLoginAt == null) {
        return false; // ì²« ë¡œê·¸ì¸ ì‹œë„ â†’ íœ´ë©´ ì•„ë‹˜
    }
    
    LocalDateTime threeMonthsAgo = LocalDateTime.now().minusMonths(3);
    return lastLoginAt.isBefore(threeMonthsAgo);
}
```

#### Step 6: ì¿ í‚¤ ìƒì„± ë° ì„¤ì •

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/util/ResponseCookieUtil.java`

```java
@Component
@RequiredArgsConstructor
public class ResponseCookieUtil {
    
    public static final String ACCESS_TOKEN_COOKIE_NAME = "accessToken";
    public static final String REFRESH_TOKEN_COOKIE_NAME = "refreshToken";
    private static final String COOKIE_PATH = "/";
    private static final String SAME_SITE = "Lax";
    
    private final CookieConfig cookieConfig;
    private final JwtTokenProvider jwtTokenProvider;
    
    // AccessToken ì¿ í‚¤ ìƒì„±
    public ResponseCookie createAccessTokenCookie(String accessToken) {
        return ResponseCookie.from(ACCESS_TOKEN_COOKIE_NAME, accessToken)
                .httpOnly(true)              // JavaScript ì ‘ê·¼ ë¶ˆê°€ (XSS ë°©ì§€)
                .secure(cookieConfig.isSecureCookie())  // HTTPSë§Œ (í”„ë¡œë•ì…˜)
                .path(COOKIE_PATH)          // ëª¨ë“  ê²½ë¡œì—ì„œ ì‚¬ìš©
                .maxAge(jwtTokenProvider.getAccessTokenExpiration())  // 1ì‹œê°„
                .sameSite(SAME_SITE)        // CSRF ë°©ì§€
                .build();
    }
    
    // RefreshToken ì¿ í‚¤ ìƒì„±
    public ResponseCookie createRefreshTokenCookie(String refreshToken) {
        return ResponseCookie.from(REFRESH_TOKEN_COOKIE_NAME, refreshToken)
                .httpOnly(true)
                .secure(cookieConfig.isSecureCookie())
                .path(COOKIE_PATH)
                .maxAge(jwtTokenProvider.getRefreshTokenExpiration())  // 3ì¼
                .sameSite(SAME_SITE)
                .build();
    }
    
    // ë‘ í† í° ëª¨ë‘ ì¿ í‚¤ì— ì¶”ê°€
    public void addTokenCookies(HttpServletResponse response, TokenPair tokenPair) {
        addAccessTokenCookie(response, tokenPair.accessToken());
        addRefreshTokenCookie(response, tokenPair.refreshToken());
    }
}
```

---

## 5. ì¸ì¦ëœ ìš”ì²­ ì²˜ë¦¬ íë¦„

### 5.1 ì „ì²´ íë¦„ë„

```
ë¸Œë¼ìš°ì €: GET /mypage (ì¿ í‚¤: accessToken=xxx)
  â†“
Front ì„œë²„: JwtAuthenticationFilter
  - ì¿ í‚¤ì—ì„œ accessToken ì¶”ì¶œ
  - Auth ì„œë²„ì— í† í° ê²€ì¦ ìš”ì²­
  - SecurityContextì— ì¸ì¦ ì •ë³´ ì €ì¥
  â†“
Front ì„œë²„: AuthorizationFilter
  - SecurityContextì—ì„œ Authentication í™•ì¸
  - authenticated() ì²´í¬ â†’ í†µê³¼
  â†“
Controller: /mypage ì²˜ë¦¬
```

### 5.2 JwtAuthenticationFilter ìƒì„¸

**íŒŒì¼**: `chaekmate-front/src/main/java/shop/chaekmate/front/auth/filter/JwtAuthenticationFilter.java`

```java
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    private final AuthService authService;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) {
        
        // 1. ì¿ í‚¤ì—ì„œ í† í° ì¶”ì¶œ
        String accessToken = CookieUtil.extractAccessTokenFromCookie(request);
        String refreshToken = CookieUtil.extractRefreshTokenFromCookie(request);
        
        // 2. í† í°ì´ ì—†ìœ¼ë©´ ì¸ì¦ ì—†ì´ í†µê³¼
        if(accessToken == null && refreshToken == null) {
            clearSecurityContext();
            filterChain.doFilter(request, response);
            return;
        }
        
        // 3. AccessToken ê²€ì¦
        if (accessToken != null) {
            try {
                // Auth ì„œë²„ì— í† í° ê²€ì¦ ìš”ì²­
                ResponseEntity<MemberInfoResponse> memberInfoResponse = 
                    authService.getMemberInfo(accessToken);
                
                // 4. ê²€ì¦ ì„±ê³µ ì‹œ SecurityContextì— ì¸ì¦ ì •ë³´ ì €ì¥
                if (memberInfoResponse.getStatusCode().is2xxSuccessful() &&
                        memberInfoResponse.getBody() != null) {
                    setAuthentication(memberInfoResponse.getBody());
                }
            } catch (Exception e) {
                // 5. AccessToken ë§Œë£Œ â†’ RefreshTokenìœ¼ë¡œ ì¬ë°œê¸‰
                handleTokenRefresh(request, response);
            }
        } else {
            // AccessToken ì—†ìŒ â†’ RefreshTokenìœ¼ë¡œ ì¬ë°œê¸‰
            handleTokenRefresh(request, response);
        }
        
        // 6. ë‹¤ìŒ í•„í„°ë¡œ ì „ë‹¬
        filterChain.doFilter(request, response);
    }
    
    // SecurityContextì— ì¸ì¦ ì •ë³´ ì €ì¥
    private void setAuthentication(MemberInfoResponse memberInfo) {
        // 1. Principal ìƒì„±
        CustomPrincipal principal = new CustomPrincipal(
            memberInfo.memberId(),
            memberInfo.name(),
            memberInfo.role()
        );
        
        // 2. ê¶Œí•œ ì„¤ì •
        String role = memberInfo.role();
        List<SimpleGrantedAuthority> authorities = List.of(
            new SimpleGrantedAuthority("ROLE_" + role)
        );
        
        // 3. Authentication ê°ì²´ ìƒì„±
        Authentication auth = new UsernamePasswordAuthenticationToken(
            principal,
            null,  // credentials (JWTì—ì„œëŠ” null)
            authorities
        );
        
        // 4. SecurityContextì— ì €ì¥
        SecurityContextHolder.getContext().setAuthentication(auth);
    }
}
```

### 5.3 Auth ì„œë²„ - í† í° ê²€ì¦

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/controller/AuthController.java`

```java
@GetMapping("/me")
@RequireMember
public ResponseEntity<MemberInfoResponse> getMemberInfo(
        @CookieValue("accessToken") String token) {
    
    // 1. í† í° íŒŒì‹± ë° ê²€ì¦
    Long id = jwtTokenProvider.getMemberIdFromToken(token);
    String userType = jwtTokenProvider.getUserTypeFromToken(token);
    
    // 2. DBì—ì„œ íšŒì› ì •ë³´ ì¡°íšŒ
    if (JwtTokenProvider.getTypeMember().equals(userType)) {
        Member member = memberRepository.findById(id)
                .orElseThrow(() -> new AuthException(AuthErrorCode.MEMBER_NOT_FOUND));
        return ResponseEntity.ok(new MemberInfoResponse(
            member.getId(),
            member.getName(),
            "USER"
        ));
    }
    else if (JwtTokenProvider.getTypeAdmin().equals(userType)) {
        Admin admin = adminRepository.findById(id)
                .orElseThrow(() -> new AuthException(AuthErrorCode.MEMBER_NOT_FOUND));
        return ResponseEntity.ok(new MemberInfoResponse(
            admin.getId(),
            "admin",
            "ADMIN"
        ));
    }
    
    throw new AuthException(AuthErrorCode.MEMBER_NOT_FOUND);
}
```

### 5.4 AuthorizationFilter - ê¶Œí•œ ì²´í¬

```java
// Spring Security ë‚´ë¶€ í•„í„°
// SecurityConfigì˜ authorizeHttpRequests() ì„¤ì •ì— ë”°ë¼ ë™ì‘

// ì˜ˆì‹œ: /admin/** ê²½ë¡œ ìš”ì²­
1. SecurityContextì—ì„œ Authentication ì¡°íšŒ
2. hasRole("ADMIN") ì²´í¬
3. ê¶Œí•œ ì—†ìœ¼ë©´ AccessDeniedException ë°œìƒ
4. ExceptionTranslationFilterê°€ ì²˜ë¦¬
```

---

## 6. í† í° ì¬ë°œê¸‰ íë¦„

### 6.1 ì „ì²´ íë¦„ë„

```
AccessToken ë§Œë£Œ
  â†“
JwtAuthenticationFilter: AccessToken ê²€ì¦ ì‹¤íŒ¨ ê°ì§€
  â†“
handleTokenRefresh() í˜¸ì¶œ
  â†“
RefreshTokenìœ¼ë¡œ ì¬ë°œê¸‰ ìš”ì²­ (Auth ì„œë²„)
  â†“
Auth ì„œë²„: RefreshToken ê²€ì¦
  - JWT ê²€ì¦
  - Redisì—ì„œ RefreshToken í™•ì¸
  â†“
ìƒˆë¡œìš´ AccessToken + RefreshToken ë°œê¸‰
  â†“
ì¿ í‚¤ ì—…ë°ì´íŠ¸ + Redis ì—…ë°ì´íŠ¸
  â†“
ìƒˆ AccessTokenìœ¼ë¡œ ì¸ì¦ ì •ë³´ ì„¤ì •
```

### 6.2 Front ì„œë²„ - í† í° ì¬ë°œê¸‰ ì²˜ë¦¬

**íŒŒì¼**: `chaekmate-front/src/main/java/shop/chaekmate/front/auth/filter/JwtAuthenticationFilter.java`

```java
private void handleTokenRefresh(HttpServletRequest request, 
                                HttpServletResponse response) {
    // 1. RefreshToken ì¶”ì¶œ
    String refreshToken = CookieUtil.extractRefreshTokenFromCookie(request);
    if (refreshToken == null) {
        clearSecurityContext();
        return;
    }
    
    try {
        // 2. Auth ì„œë²„ì— ì¬ë°œê¸‰ ìš”ì²­
        ResponseEntity<LoginResponse> refreshResponse = 
            authService.refreshToken(refreshToken);
        
        if (refreshResponse.getStatusCode().is2xxSuccessful()) {
            // 3. ìƒˆ í† í°ì„ ì¿ í‚¤ì— ì„¤ì •
            String newAccessToken = extractAndSetCookies(refreshResponse, response);
            
            if (newAccessToken != null) {
                // 4. ìƒˆ AccessTokenìœ¼ë¡œ ì¸ì¦ ì •ë³´ ì„¤ì •
                authenticateWithNewToken(newAccessToken);
            } else {
                clearSecurityContext();
            }
        }
    } catch (Exception e) {
        // ì¬ë°œê¸‰ ì‹¤íŒ¨ â†’ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
        clearSecurityContext();
    }
}

// ì¿ í‚¤ ì¶”ì¶œ ë° ì„¤ì •
private String extractAndSetCookies(ResponseEntity<LoginResponse> refreshResponse, 
                                     HttpServletResponse response) {
    if (!refreshResponse.getHeaders().containsKey(HttpHeaders.SET_COOKIE)) {
        return null;
    }
    
    List<String> cookieHeaders = refreshResponse.getHeaders().get(HttpHeaders.SET_COOKIE);
    if (cookieHeaders == null) {
        return null;
    }
    
    String newAccessToken = null;
    for (String cookieHeader : cookieHeaders) {
        // ë¸Œë¼ìš°ì €ì— ì¿ í‚¤ ì„¤ì •
        response.addHeader(HttpHeaders.SET_COOKIE, cookieHeader);
        
        // AccessToken ì¶”ì¶œ
        if (cookieHeader.startsWith("accessToken=")) {
            String[] parts = cookieHeader.split(";")[0].split("=", 2);
            if (parts.length == 2) {
                newAccessToken = parts[1];
            }
        }
    }
    
    return newAccessToken;
}
```

### 6.3 Auth ì„œë²„ - í† í° ì¬ë°œê¸‰ ì²˜ë¦¬

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/service/AuthService.java`

```java
public TokenPair refreshToken(String refreshToken) {
    // 1. RefreshToken ê²€ì¦ (JWT êµ¬ì¡° ë° ì„œëª… ê²€ì¦)
    if (!jwtTokenProvider.validateRefreshToken(refreshToken)) {
        throw new AuthException(AuthErrorCode.REFRESH_TOKEN_INVALID);
    }
    
    // 2. memberId ë° userType ì¶”ì¶œ
    Long memberId = jwtTokenProvider.getMemberIdFromToken(refreshToken);
    String userType = jwtTokenProvider.getUserTypeFromToken(refreshToken);
    
    // 3. Redisì—ì„œ RefreshToken ê²€ì¦
    String redisKey = "refresh:" + memberId;
    String storedRefreshToken = redisTemplate.opsForValue().get(redisKey);
    
    if (storedRefreshToken == null || !storedRefreshToken.equals(refreshToken)) {
        throw new AuthException(AuthErrorCode.REFRESH_TOKEN_INVALID);
    }
    
    // 4. ìƒˆë¡œìš´ í† í° ìƒì„±
    TokenPair newTokenPair = jwtTokenProvider.createTokenPair(memberId, userType);
    
    // 5. Redis ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì‚­ì œ, ìƒˆë¡œ ì €ì¥)
    long refreshExpirationMillis = jwtTokenProvider.getRefreshTokenExpiration() * 1000;
    Boolean success = redisTemplate.opsForValue().setIfPresent(
        redisKey,
        newTokenPair.refreshToken(),
        Duration.ofMillis(refreshExpirationMillis)
    );
    
    if (!Boolean.TRUE.equals(success)) {
        // ë‹¤ë¥¸ ìš”ì²­ì´ ë¨¼ì € í† í°ì„ ë³€ê²½í–ˆê±°ë‚˜ í† í°ì´ ì´ë¯¸ ì‚­ì œë¨
        throw new AuthException(AuthErrorCode.REFRESH_TOKEN_INVALID);
    }
    
    return newTokenPair;
}
```

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/controller/AuthController.java`

```java
@PostMapping("/refresh")
public ResponseEntity<LoginResponse> refreshToken(
        @CookieValue("refreshToken") String refreshToken,
        HttpServletResponse response) {
    
    // 1. í† í° ì¬ë°œê¸‰
    TokenPair tokenPair = authService.refreshToken(refreshToken);
    
    // 2. ìƒˆ í† í° ì¿ í‚¤ ì„¤ì •
    responseCookieUtil.addTokenCookies(response, tokenPair);
    
    return ResponseEntity.ok(new LoginResponse("í† í° ì¬ë°œê¸‰ ì„±ê³µ"));
}
```

---

## 7. ë¡œê·¸ì•„ì›ƒ íë¦„

### 7.1 ì „ì²´ íë¦„ë„

```
ì‚¬ìš©ì: POST /logout
  â†“
Front ì„œë²„: LogoutFilter ê°ì§€
  â†“
CustomLogoutHandler ì‹¤í–‰
  - ì¿ í‚¤ì—ì„œ í† í° ì¶”ì¶œ
  - Auth ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­
  - Redisì—ì„œ RefreshToken ì‚­ì œ
  - ì¿ í‚¤ ì‚­ì œ (maxAge=0)
  â†“
/ ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
```

### 7.2 Front ì„œë²„ - CustomLogoutHandler

**íŒŒì¼**: `chaekmate-front/src/main/java/shop/chaekmate/front/auth/handler/CustomLogoutHandler.java`

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class CustomLogoutHandler implements LogoutHandler {
    
    private final AuthService authService;
    private final CookieConfig cookieConfig;
    
    @Override
    public void logout(HttpServletRequest request, 
                      HttpServletResponse response, 
                      Authentication authentication) {
        
        // 1. ì¿ í‚¤ì—ì„œ í† í° ì¶”ì¶œ
        String accessToken = CookieUtil.extractAccessTokenFromCookie(request);
        String refreshToken = CookieUtil.extractRefreshTokenFromCookie(request);
        
        // 2. Auth ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­ (Redisì—ì„œ RefreshToken ì‚­ì œ)
        if (accessToken != null && refreshToken != null) {
            try {
                authService.logout(accessToken, refreshToken);
            } catch (Exception e) {
                log.warn("ë¡œê·¸ì•„ì›ƒ ì¤‘ Auth Server í˜¸ì¶œ ì‹¤íŒ¨: {}", e.getMessage());
            }
        }
        
        // 3. Front ì„œë²„ì—ì„œ ì¿ í‚¤ ì‚­ì œ
        ResponseCookie deleteAccessCookie = ResponseCookie.from("accessToken", "")
                .httpOnly(true)
                .secure(cookieConfig.isSecureCookie())
                .path("/")
                .maxAge(0)  // ì¦‰ì‹œ ì‚­ì œ
                .sameSite("Lax")
                .build();
        
        ResponseCookie deleteRefreshCookie = ResponseCookie.from("refreshToken", "")
                .httpOnly(true)
                .secure(cookieConfig.isSecureCookie())
                .path("/")
                .maxAge(0)  // ì¦‰ì‹œ ì‚­ì œ
                .sameSite("Lax")
                .build();
        
        response.addHeader(HttpHeaders.SET_COOKIE, deleteAccessCookie.toString());
        response.addHeader(HttpHeaders.SET_COOKIE, deleteRefreshCookie.toString());
    }
}
```

### 7.3 Auth ì„œë²„ - ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/controller/AuthController.java`

```java
@PostMapping("/logout")
@RequireMember
public ResponseEntity<LogoutResponse> logout(
        @CookieValue(value = "accessToken", required = false) String accessToken,
        @CookieValue(value = "refreshToken", required = false) String refreshToken) {
    
    Long memberId = null;
    
    // 1. AccessTokenì—ì„œ memberId ì¶”ì¶œ ì‹œë„
    if (accessToken != null && !accessToken.trim().isEmpty()) {
        try {
            memberId = jwtTokenProvider.getMemberIdFromToken(accessToken);
        } catch (AuthException e) {
            // AccessToken ë§Œë£Œë¨
        }
    }
    
    // 2. AccessToken ì‹¤íŒ¨ ì‹œ RefreshTokenì—ì„œ ì¶”ì¶œ
    if (memberId == null && refreshToken != null && !refreshToken.trim().isEmpty()) {
        try {
            memberId = jwtTokenProvider.getMemberIdFromToken(refreshToken);
        } catch (AuthException e) {
            // RefreshTokenë„ ë§Œë£Œë¨
        }
    }
    
    // 3. Redisì—ì„œ RefreshToken ì‚­ì œ
    if(memberId != null) {
        String redisKey = "refresh:" + memberId;
        redisTemplate.delete(redisKey);
    }
    
    return ResponseEntity.ok(new LogoutResponse("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ"));
}
```

---

## 8. ê¶Œí•œ ì²´í¬ (AOP)

### 8.1 Core ì„œë²„ - ê¶Œí•œ ì²´í¬ íë¦„

```
Gateway ì„œë²„: JWT ê²€ì¦ í›„ í—¤ë” ì¶”ê°€
  - X-Member-Id: 123
  - X-User-Role: ADMIN
  â†“
Core ì„œë²„: RoleCheckAspect
  - @RequiredAdmin ë˜ëŠ” @RequiredMember ê°ì§€
  - í—¤ë”ì—ì„œ ì •ë³´ ì¶”ì¶œ
  - ê¶Œí•œ ì²´í¬
  â†“
Controller ì‹¤í–‰
```

### 8.2 Gateway ì„œë²„ - í—¤ë” ì¶”ê°€

**íŒŒì¼**: `chaekmate-gateway/src/main/java/shop/chaekmate/gateway/filter/JwtValidationFilter.java`

```java
@Override
public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
    ServerHttpRequest request = exchange.getRequest();
    String accessToken = extractAccessTokenFromCookie(request);
    
    if (!StringUtils.hasText(accessToken)) {
        return chain.filter(exchange);
    }
    
    // Auth ì„œë²„ì— í† í° ê²€ì¦ ìš”ì²­
    WebClient webClient = webClientBuilder.build();
    
    return webClient.get()
            .uri("lb://chaekmate-auth/auth/me")
            .header("Cookie", "accessToken=" + accessToken)
            .retrieve()
            .bodyToMono(MemberInfoResponse.class)
            .flatMap(memberInfo -> {
                // í—¤ë”ì— ì‚¬ìš©ì ì •ë³´ ì¶”ê°€ (Core ì„œë²„ì— ì „ë‹¬)
                ServerHttpRequest modifiedRequest = request.mutate()
                        .header("X-Member-Id", String.valueOf(memberInfo.memberId()))
                        .header("X-User-Role", memberInfo.role())  // "USER" or "ADMIN"
                        .build();
                
                return chain.filter(exchange.mutate().request(modifiedRequest).build());
            })
            .onErrorResume(e -> {
                // ê²€ì¦ ì‹¤íŒ¨ ì‹œ 401 ë°˜í™˜
                ServerHttpResponse response = exchange.getResponse();
                response.setStatusCode(HttpStatus.UNAUTHORIZED);
                return response.setComplete();
            });
}
```

### 8.3 Core ì„œë²„ - RoleCheckAspect

**íŒŒì¼**: `chaekmate-core/src/main/java/shop/chaekmate/core/common/aop/RoleCheckAspect.java`

```java
@Aspect
@Component
@RequiredArgsConstructor
@Slf4j
public class RoleCheckAspect {
    
    private static final String X_MEMBER_ID = "X-Member-Id";
    private static final String X_USER_ROLE = "X-User-Role";
    
    // @RequiredMember ì–´ë…¸í…Œì´ì…˜ ì²´í¬
    @Around("@annotation(shop.chaekmate.core.common.annotation.RequiredMember)")
    public Object checkMember(ProceedingJoinPoint joinPoint) throws Throwable {
        HttpServletRequest request = getRequest();
        if (request == null) {
            throw new CoreException(CommonErrorCode.TOKEN_INVALID);
        }
        
        // í—¤ë”ì—ì„œ ì •ë³´ ì¶”ì¶œ
        String memberId = request.getHeader(X_MEMBER_ID);
        String role = request.getHeader(X_USER_ROLE);
        
        if (memberId == null || role == null) {
            throw new CoreException(CommonErrorCode.TOKEN_INVALID);
        }
        
        // USER ë˜ëŠ” ADMINì´ë©´ í†µê³¼
        if ("USER".equals(role) || "ADMIN".equals(role)) {
            log.debug("íšŒì› ê¶Œí•œ ì²´í¬ í†µê³¼: memberId={}, role={}", memberId, role);
            return joinPoint.proceed();
        }
        
        throw new CoreException(CommonErrorCode.TOKEN_INVALID);
    }
    
    // @RequiredAdmin ì–´ë…¸í…Œì´ì…˜ ì²´í¬
    @Around("@annotation(shop.chaekmate.core.common.annotation.RequiredAdmin)")
    public Object checkAdmin(ProceedingJoinPoint joinPoint) throws Throwable {
        HttpServletRequest request = getRequest();
        if (request == null) {
            throw new CoreException(CommonErrorCode.TOKEN_INVALID);
        }
        
        // í—¤ë”ì—ì„œ ì •ë³´ ì¶”ì¶œ
        String memberId = request.getHeader(X_MEMBER_ID);
        String role = request.getHeader(X_USER_ROLE);
        
        if (memberId == null || role == null) {
            throw new CoreException(CommonErrorCode.TOKEN_INVALID);
        }
        
        // ADMIN ê¶Œí•œ ì²´í¬
        if ("ADMIN".equals(role)) {
            log.debug("ê´€ë¦¬ì ê¶Œí•œ ì²´í¬ í†µê³¼: memberId={}", memberId);
            return joinPoint.proceed();
        }
        
        throw new CoreException(CommonErrorCode.TOKEN_INVALID);
    }
    
    private HttpServletRequest getRequest() {
        ServletRequestAttributes attributes =
                (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes == null) {
            return null;
        }
        return attributes.getRequest();
    }
}
```

### 8.4 ì‚¬ìš© ì˜ˆì‹œ

```java
// Core ì„œë²„: WrapperController.java
@RestController
@RequestMapping("/admin/wrappers")
@RequiredArgsConstructor
public class WrapperController {
    
    @PostMapping
    @RequiredAdmin  // AOPê°€ ê¶Œí•œ ì²´í¬
    public ResponseEntity<ApiResponse<WrapperResponse>> createWrapper(
            @RequestBody WrapperRequest request) {
        // ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
        // ...
    }
}
```

---

## 9. ì¿ í‚¤ ê´€ë¦¬

### 9.1 ì¿ í‚¤ ì†ì„± ìƒì„¸

```java
ResponseCookie.from("accessToken", token)
    .httpOnly(true)              // JavaScript ì ‘ê·¼ ë¶ˆê°€
    .secure(true)                // HTTPSë§Œ ì „ì†¡ (í”„ë¡œë•ì…˜)
    .path("/")                   // ëª¨ë“  ê²½ë¡œì—ì„œ ì‚¬ìš©
    .maxAge(3600)                // 1ì‹œê°„ (ì´ˆ ë‹¨ìœ„)
    .sameSite("Lax")            // CSRF ë°©ì§€
    .build();
```

#### httpOnly
- **ëª©ì **: XSS ê³µê²© ë°©ì§€
- **ë™ì‘**: JavaScriptì—ì„œ `document.cookie`ë¡œ ì ‘ê·¼ ë¶ˆê°€
- **ì˜ˆì‹œ**: 
  ```javascript
  // âŒ ì ‘ê·¼ ë¶ˆê°€
  document.cookie;  // accessTokenì´ ë³´ì´ì§€ ì•ŠìŒ
  ```

#### secure
- **ëª©ì **: HTTPSì—ì„œë§Œ ì „ì†¡
- **ë™ì‘**: HTTP ìš”ì²­ì—ì„œëŠ” ì¿ í‚¤ ì „ì†¡ ì•ˆ ë¨
- **ì„¤ì •**: 
  ```java
  // ê°œë°œ í™˜ê²½: false
  // í”„ë¡œë•ì…˜ í™˜ê²½: true
  .secure(cookieConfig.isSecureCookie())
  ```

#### sameSite
- **ëª©ì **: CSRF ê³µê²© ë°©ì§€
- **ê°’**:
  - `Strict`: ëª¨ë“  í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ì—ì„œ ì¿ í‚¤ ì „ì†¡ ì•ˆ ë¨
  - `Lax`: GET ìš”ì²­ê³¼ ìµœìƒìœ„ íƒìƒ‰ì—ì„œë§Œ ì „ì†¡ (ê¸°ë³¸ê°’)
  - `None`: ëª¨ë“  í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ì—ì„œ ì „ì†¡ (secure=true í•„ìš”)

### 9.2 ì¿ í‚¤ ì¶”ì¶œ

**íŒŒì¼**: `chaekmate-front/src/main/java/shop/chaekmate/front/auth/util/CookieUtil.java`

```java
public class CookieUtil {
    
    private static final String ACCESS_TOKEN_COOKIE_NAME = "accessToken";
    private static final String REFRESH_TOKEN_COOKIE_NAME = "refreshToken";
    
    // ì¿ í‚¤ì—ì„œ AccessToken ì¶”ì¶œ
    public static String extractAccessTokenFromCookie(HttpServletRequest request) {
        if(request == null) {
            return null;
        }
        
        Cookie[] cookies = request.getCookies();
        if(cookies == null) {
            return null;
        }
        
        for(Cookie cookie : cookies) {
            if(ACCESS_TOKEN_COOKIE_NAME.equals(cookie.getName())){
                return cookie.getValue();
            }
        }
        return null;
    }
    
    // ì¿ í‚¤ì—ì„œ RefreshToken ì¶”ì¶œ
    public static String extractRefreshTokenFromCookie(HttpServletRequest request) {
        // ë™ì¼í•œ ë¡œì§
    }
}
```

### 9.3 ì¿ í‚¤ ì‚­ì œ

```java
// maxAgeë¥¼ 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì¦‰ì‹œ ì‚­ì œ
ResponseCookie deleteCookie = ResponseCookie.from("accessToken", "")
        .httpOnly(true)
        .secure(cookieConfig.isSecureCookie())
        .path("/")
        .maxAge(0)  // ì¦‰ì‹œ ì‚­ì œ
        .sameSite("Lax")
        .build();

response.addHeader(HttpHeaders.SET_COOKIE, deleteCookie.toString());
```

---

## 10. Redis ì‚¬ìš©

### 10.1 RefreshToken ì €ì¥ êµ¬ì¡°

```
Key: refresh:{memberId}
Value: refreshToken (JWT ë¬¸ìì—´)
TTL: 3ì¼ (259200ì´ˆ)
```

### 10.2 Redis ì €ì¥ ì½”ë“œ

**íŒŒì¼**: `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/controller/AuthController.java`

```java
// ë¡œê·¸ì¸ ì‹œ
Long memberId = jwtTokenProvider.getMemberIdFromToken(tokenPair.accessToken());
String redisKey = "refresh:" + memberId;
long refreshExpirationMillis = jwtTokenProvider.getRefreshTokenExpiration() * 1000;
redisTemplate.opsForValue().set(
    redisKey, 
    tokenPair.refreshToken(),
    Duration.ofMillis(refreshExpirationMillis)  // 3ì¼
);
```

### 10.3 Redis ê²€ì¦ ì½”ë“œ

```java
// í† í° ì¬ë°œê¸‰ ì‹œ
String redisKey = "refresh:" + memberId;
String storedRefreshToken = redisTemplate.opsForValue().get(redisKey);

if (storedRefreshToken == null || !storedRefreshToken.equals(refreshToken)) {
    throw new AuthException(AuthErrorCode.REFRESH_TOKEN_INVALID);
}
```

### 10.4 Redis ì‚­ì œ ì½”ë“œ

```java
// ë¡œê·¸ì•„ì›ƒ ì‹œ
String redisKey = "refresh:" + memberId;
redisTemplate.delete(redisKey);
```

### 10.5 Redisë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 

1. **ì¦‰ì‹œ ë¬´íš¨í™”**: ë¡œê·¸ì•„ì›ƒ ì‹œ ì¦‰ì‹œ RefreshToken ë¬´íš¨í™” ê°€ëŠ¥
2. **ë³´ì•ˆ**: ì„œë²„ ì¸¡ì—ì„œ RefreshToken ê´€ë¦¬
3. **í™•ì¥ì„±**: ì—¬ëŸ¬ ì„œë²„ì—ì„œ ë™ì¼í•œ Redis ì‚¬ìš© ê°€ëŠ¥
4. **TTL ìë™ ê´€ë¦¬**: ë§Œë£Œ ì‹œê°„ ìë™ ì²˜ë¦¬

---

## 11. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 11.1 XSS (Cross-Site Scripting) ë°©ì§€

```java
.httpOnly(true)  // JavaScript ì ‘ê·¼ ë¶ˆê°€
```

- **ê³µê²© ì‹œë‚˜ë¦¬ì˜¤**: ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ê°€ `document.cookie`ë¡œ í† í° íƒˆì·¨
- **ë°©ì–´**: `httpOnly`ë¡œ JavaScript ì ‘ê·¼ ì°¨ë‹¨

### 11.2 CSRF (Cross-Site Request Forgery) ë°©ì§€

```java
.sameSite("Lax")  // CSRF ë°©ì§€
.csrf(AbstractHttpConfigurer::disable)  // JWT ê¸°ë°˜ì´ë¯€ë¡œ ë¹„í™œì„±í™”
```

- **ê³µê²© ì‹œë‚˜ë¦¬ì˜¤**: ì•…ì„± ì‚¬ì´íŠ¸ì—ì„œ ì¿ í‚¤ë¥¼ ì´ìš©í•œ ìš”ì²­
- **ë°©ì–´**: `sameSite="Lax"`ë¡œ í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ ì œí•œ
- **JWT ê¸°ë°˜**: Statelessì´ë¯€ë¡œ CSRF ìœ„í—˜ ë‚®ìŒ

### 11.3 ì¤‘ê°„ì ê³µê²© (Man-in-the-Middle) ë°©ì§€

```java
.secure(true)  // HTTPSë§Œ ì „ì†¡
```

- **ê³µê²© ì‹œë‚˜ë¦¬ì˜¤**: HTTP í†µì‹ ì—ì„œ í† í° íƒˆì·¨
- **ë°©ì–´**: `secure`ë¡œ HTTPSì—ì„œë§Œ ì¿ í‚¤ ì „ì†¡

### 11.4 í† í° íƒˆì·¨ ëŒ€ì‘

1. **ì§§ì€ AccessToken ìˆ˜ëª…**: 1ì‹œê°„ (í”¼í•´ ìµœì†Œí™”)
2. **RefreshToken ì´ì¤‘ ì €ì¥**: ì¿ í‚¤ + Redis (ì¦‰ì‹œ ë¬´íš¨í™” ê°€ëŠ¥)
3. **í† í° ì¬ë°œê¸‰ ì‹œ ê²€ì¦**: Redisì—ì„œ RefreshToken í™•ì¸

### 11.5 ë¹„ë°€ë²ˆí˜¸ ë³´ì•ˆ

```java
// BCrypt í•´ì‹±
BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();
String hashedPassword = passwordEncoder.encode(password);

// ê²€ì¦
boolean matches = passwordEncoder.matches(rawPassword, hashedPassword);
```

---

## 12. ì„œë²„ë³„ ì—­í•  ìƒì„¸

### 12.1 Front ì„œë²„

**ì—­í• **:
- ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ì œê³µ (Thymeleaf)
- JWT ì¸ì¦ í•„í„° (JwtAuthenticationFilter)
- ì¿ í‚¤ ê´€ë¦¬ (ë¸Œë¼ìš°ì €ì— ì „ë‹¬)
- Auth ì„œë²„ì™€ í†µì‹  (FeignClient)

**ì£¼ìš” íŒŒì¼**:
- `AuthController.java`: ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
- `JwtAuthenticationFilter.java`: JWT ê²€ì¦ ë° SecurityContext ì„¤ì •
- `SecurityConfig.java`: Spring Security ì„¤ì •
- `CustomLogoutHandler.java`: ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬

### 12.2 Gateway ì„œë²„

**ì—­í• **:
- API Gateway (ë‹¨ì¼ ì§„ì…ì )
- JWT ê²€ì¦ ë° í—¤ë” ì¶”ê°€
- ì„œë¹„ìŠ¤ ë¼ìš°íŒ… (Eureka ê¸°ë°˜)

**ì£¼ìš” íŒŒì¼**:
- `JwtValidationFilter.java`: JWT ê²€ì¦ ë° í—¤ë” ì¶”ê°€

### 12.3 Auth ì„œë²„

**ì—­í• **:
- JWT í† í° ë°œê¸‰/ê²€ì¦
- RefreshToken ê´€ë¦¬ (Redis)
- íšŒì› ì¸ì¦ (ë¹„ë°€ë²ˆí˜¸ ê²€ì¦)
- íœ´ë©´ ê³„ì • ì²˜ë¦¬

**ì£¼ìš” íŒŒì¼**:
- `AuthController.java`: ì¸ì¦ API
- `AuthService.java`: ì¸ì¦ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- `JwtTokenProvider.java`: JWT ìƒì„±/ê²€ì¦
- `ResponseCookieUtil.java`: ì¿ í‚¤ ìƒì„±

### 12.4 Core ì„œë²„

**ì—­í• **:
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
- ê¶Œí•œ ì²´í¬ (AOP)
- Gatewayì—ì„œ ì „ë‹¬ë°›ì€ í—¤ë” ì‚¬ìš©

**ì£¼ìš” íŒŒì¼**:
- `RoleCheckAspect.java`: ê¶Œí•œ ì²´í¬ AOP

---

## 13. ì£¼ìš” ê°œë… ì •ë¦¬

### 13.1 Stateless ì¸ì¦

- **ì˜ë¯¸**: ì„œë²„ì— ì„¸ì…˜ ìƒíƒœ ì €ì¥ ì•ˆ í•¨
- **ì¥ì **: ì„œë²„ í™•ì¥ì„±, ë¡œë“œ ë°¸ëŸ°ì‹± ìš©ì´
- **ë‹¨ì **: í† í° ì¦‰ì‹œ ë¬´íš¨í™” ì–´ë ¤ì›€ (Redisë¡œ ë³´ì™„)

### 13.2 JWT vs Session

| êµ¬ë¶„ | JWT | Session |
|------|-----|---------|
| **ì„œë²„ ì €ì¥** | âŒ ì—†ìŒ | âœ… ì„¸ì…˜ ì €ì¥ì†Œ |
| **í™•ì¥ì„±** | â­â­â­â­â­ | â­â­â­ |
| **í† í° í¬ê¸°** | í¼ | ì‘ìŒ (ì„¸ì…˜ IDë§Œ) |
| **ì¦‰ì‹œ ë¬´íš¨í™”** | ì–´ë ¤ì›€ | ì‰¬ì›€ |

### 13.3 AccessToken vs RefreshToken

| êµ¬ë¶„ | AccessToken | RefreshToken |
|------|-------------|--------------|
| **ìˆ˜ëª…** | 1ì‹œê°„ | 3ì¼ |
| **ìš©ë„** | API ìš”ì²­ ì¸ì¦ | AccessToken ì¬ë°œê¸‰ |
| **ì €ì¥** | ì¿ í‚¤ë§Œ | ì¿ í‚¤ + Redis |
| **ê²€ì¦ ë¹ˆë„** | ë§¤ ìš”ì²­ | AccessToken ë§Œë£Œ ì‹œ |

### 13.4 í•„í„° ì²´ì¸ í•µì‹¬ í•„í„°

1. **SecurityContextHolderFilter**: SecurityContext ê´€ë¦¬
2. **JwtAuthenticationFilter**: JWT ê²€ì¦ (ì»¤ìŠ¤í…€)
3. **ExceptionTranslationFilter**: ì˜ˆì™¸ ì²˜ë¦¬
4. **AuthorizationFilter**: ê¶Œí•œ ì²´í¬
5. **LogoutFilter**: ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬

---

## 14. ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ

### 14.1 ë¡œê·¸ì¸

```bash
# 1. ì‚¬ìš©ì ì…ë ¥
POST /login
loginId=testuser
password=1234

# 2. ì‘ë‹µ
Set-Cookie: accessToken=eyJhbGc...; HttpOnly; Secure; SameSite=Lax; Max-Age=3600
Set-Cookie: refreshToken=eyJhbGc...; HttpOnly; Secure; SameSite=Lax; Max-Age=259200

# 3. Redis ì €ì¥
Key: refresh:1
Value: eyJhbGc... (refreshToken)
TTL: 259200ì´ˆ (3ì¼)
```

### 14.2 API ìš”ì²­

```bash
# 1. ìš”ì²­
GET /mypage
Cookie: accessToken=eyJhbGc...

# 2. JwtAuthenticationFilter
- ì¿ í‚¤ì—ì„œ accessToken ì¶”ì¶œ
- Auth ì„œë²„ì— ê²€ì¦ ìš”ì²­
- SecurityContextì— ì¸ì¦ ì •ë³´ ì €ì¥

# 3. AuthorizationFilter
- SecurityContextì—ì„œ Authentication í™•ì¸
- authenticated() ì²´í¬ â†’ í†µê³¼

# 4. Controller ì‹¤í–‰
```

### 14.3 í† í° ë§Œë£Œ ì‹œ

```bash
# 1. ìš”ì²­
GET /mypage
Cookie: accessToken=expired, refreshToken=valid

# 2. JwtAuthenticationFilter
- AccessToken ê²€ì¦ ì‹¤íŒ¨
- handleTokenRefresh() í˜¸ì¶œ

# 3. í† í° ì¬ë°œê¸‰
POST /auth/refresh
Cookie: refreshToken=valid
â†’ ìƒˆ AccessToken + RefreshToken ë°œê¸‰

# 4. ì¿ í‚¤ ì—…ë°ì´íŠ¸
Set-Cookie: accessToken=new_token...
Set-Cookie: refreshToken=new_token...

# 5. ìš”ì²­ ê³„ì† ì§„í–‰
```

### 14.4 ë¡œê·¸ì•„ì›ƒ

```bash
# 1. ìš”ì²­
POST /logout
Cookie: accessToken=xxx, refreshToken=yyy

# 2. CustomLogoutHandler
- Auth ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­
- Redisì—ì„œ RefreshToken ì‚­ì œ

# 3. ì¿ í‚¤ ì‚­ì œ
Set-Cookie: accessToken=; Max-Age=0
Set-Cookie: refreshToken=; Max-Age=0

# 4. ë¦¬ë‹¤ì´ë ‰íŠ¸
â†’ / (í™ˆìœ¼ë¡œ)
```

---

## 15. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 15.1 í† í°ì´ ì¿ í‚¤ì— ì €ì¥ë˜ì§€ ì•ŠëŠ” ê²½ìš°

**ì›ì¸**:
- `Set-Cookie` í—¤ë”ê°€ FeignClient ì‘ë‹µì—ì„œ ë¸Œë¼ìš°ì €ë¡œ ì „ë‹¬ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
```java
// Front ì„œë²„ì—ì„œ Set-Cookie í—¤ë”ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë¸Œë¼ìš°ì €ì— ì „ë‹¬
if (gatewayResponse.getHeaders().containsKey(HttpHeaders.SET_COOKIE)) {
    List<String> cookieHeaders = gatewayResponse.getHeaders().get(HttpHeaders.SET_COOKIE);
    cookieHeaders.forEach(cookieHeader -> 
        response.addHeader(HttpHeaders.SET_COOKIE, cookieHeader)
    );
}
```

### 15.2 RefreshToken ì¬ë°œê¸‰ ì‹¤íŒ¨

**ì›ì¸**:
- Redisì— RefreshTokenì´ ì—†ìŒ (ë¡œê·¸ì•„ì›ƒë¨)
- RefreshTokenì´ ë§Œë£Œë¨
- Redisì˜ RefreshTokenê³¼ ì¿ í‚¤ì˜ RefreshToken ë¶ˆì¼ì¹˜

**í•´ê²°**:
- Redisì—ì„œ RefreshToken í™•ì¸
- TTL í™•ì¸
- ë¡œê·¸ì•„ì›ƒ ìƒíƒœ í™•ì¸

### 15.3 ê¶Œí•œ ì²´í¬ ì‹¤íŒ¨

**ì›ì¸**:
- Gatewayì—ì„œ í—¤ë” ì¶”ê°€ ì‹¤íŒ¨
- Core ì„œë²„ì—ì„œ í—¤ë” ì½ê¸° ì‹¤íŒ¨

**í•´ê²°**:
- Gatewayì˜ JwtValidationFilter í™•ì¸
- Core ì„œë²„ì˜ RoleCheckAspect í™•ì¸
- í—¤ë” ì´ë¦„ í™•ì¸ (`X-Member-Id`, `X-User-Role`)

---

## 16. ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] JWT í† í° ì„œëª… ê²€ì¦
- [x] AccessToken ì§§ì€ ìˆ˜ëª… (1ì‹œê°„)
- [x] RefreshToken Redis ì €ì¥
- [x] ì¿ í‚¤ HttpOnly ì„¤ì •
- [x] ì¿ í‚¤ Secure ì„¤ì • (í”„ë¡œë•ì…˜)
- [x] ì¿ í‚¤ SameSite ì„¤ì •
- [x] ë¹„ë°€ë²ˆí˜¸ BCrypt í•´ì‹±
- [x] CSRF ë³´í˜¸ (JWT ê¸°ë°˜ì´ë¯€ë¡œ ë¹„í™œì„±í™” ê°€ëŠ¥)
- [x] Stateless ì¸ì¦ (ì„¸ì…˜ ì‚¬ìš© ì•ˆ í•¨)
- [x] í† í° ì¬ë°œê¸‰ ì‹œ Redis ê²€ì¦

---

## 17. ì°¸ê³  ìë£Œ

### 17.1 ì£¼ìš” íŒŒì¼ ìœ„ì¹˜

**Front ì„œë²„**:
- `chaekmate-front/src/main/java/shop/chaekmate/front/auth/controller/AuthController.java`
- `chaekmate-front/src/main/java/shop/chaekmate/front/auth/filter/JwtAuthenticationFilter.java`
- `chaekmate-front/src/main/java/shop/chaekmate/front/auth/config/SecurityConfig.java`

**Auth ì„œë²„**:
- `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/controller/AuthController.java`
- `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/service/AuthService.java`
- `chaekmate-auth/src/main/java/com/nhnacademy/chaekmateauth/util/JwtTokenProvider.java`

**Gateway ì„œë²„**:
- `chaekmate-gateway/src/main/java/shop/chaekmate/gateway/filter/JwtValidationFilter.java`

**Core ì„œë²„**:
- `chaekmate-core/src/main/java/shop/chaekmate/core/common/aop/RoleCheckAspect.java`

---

ì´ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ì˜ ì¸ì¦ ì‹œìŠ¤í…œì„ ì™„ì „íˆ ì´í•´í•˜ê¸° ìœ„í•œ ê°€ì´ë“œì…ë‹ˆë‹¤.

